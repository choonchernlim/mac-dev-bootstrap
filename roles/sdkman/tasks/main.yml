---
- name: Is it installed?
  stat:
    path: '{{ sdkman_init_script }}'
  register: sdkman_installed

- name: Not installed
  block:
    - name: Download installer
      get_url:
        url: https://get.sdkman.io
        dest: /tmp
        mode: 0755

    - name: Run installer
      shell: /tmp/index.html

    - name: Delete installer
      file:
        path: /tmp/index.html
        state: absent
  when: not sdkman_installed.stat.exists

- name: Run self update
  shell: >-
    . {{ sdkman_init_script }} && sdk selfupdate
  retries: 5
  delay: 3
  register: sdkman_selfupdate
  until: sdkman_selfupdate.rc == 0
  changed_when: sdkman_selfupdate.stdout != 'No update available at this time.'
  when: sdkman_installed.stat.exists

- name: Install packages
  shell: >-
    . {{ sdkman_init_script }} && sdk install {{ item.candidate }} {{ item.version }}
  loop: '{{ sdkman_install_packages }}'
  retries: 5
  delay: 3
  register: sdkman_install_packages_output
  until: sdkman_install_packages_output.rc == 0

- name: Add to shell config dir
  copy:
    src: sdkman.sh
    dest: '{{ ohmyzsh_conf_dir }}/sdkman.sh'

- name: 'Set "sdk use [CANDIDATE] [VERSION]" in shell script'
  lineinfile:
    dest: '{{ ohmyzsh_conf_dir }}/sdkman.sh'
    line: 'sdk use {{ item.candidate }} {{ item.version }}'
  with_items:
    - '{{ sdkman_install_packages }}'
